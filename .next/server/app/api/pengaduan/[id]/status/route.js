"use strict";(()=>{var e={};e.id=981,e.ids=[981],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},5018:(e,a,t)=>{t.r(a),t.d(a,{originalPathname:()=>I,patchFetch:()=>k,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{PUT:()=>p});var n=t(9303),r=t(8716),i=t(670),o=t(7070),u=t(5662);async function p(e,{params:a}){try{let{status:t,kode_bidang:s}=await e.json(),n=a.id;if(!t)return o.NextResponse.json({success:!1,message:"Status harus diisi"},{status:400});let{data:r,error:i}=await u.p.from("pengaduan").update({status:t,updated_at:new Date().toISOString()}).eq("id",n).select(`
        *,
        kategori_pengaduan (nama_kategori),
        bidang (nama_bidang, kode_bidang)
      `).single();if(i)return console.error("Update error:",i),o.NextResponse.json({success:!1,message:"Gagal mengupdate status"},{status:500});if(await u.p.from("pengaduan_status").insert({pengaduan_id:n,status:t,keterangan:"selesai"===t?"Pengaduan telah diselesaikan oleh bidang terkait":"Status pengaduan diupdate",created_at:new Date().toISOString()}),"selesai"===t)try{await d({to:r.email_pelapor,subject:`Pengaduan ${r.kode_pengaduan} Telah Selesai`,pengaduan:{kode:r.kode_pengaduan,judul:r.judul_pengaduan,nama_pelapor:r.nama_pelapor,bidang:r.bidang?.nama_bidang||"Bidang Terkait"}}),console.log(`Email notification sent to ${r.email_pelapor}`)}catch(e){console.error("Email error:",e)}return o.NextResponse.json({success:!0,message:"selesai"===t?"Pengaduan selesai! Notifikasi email telah dikirim ke pelapor":"Status berhasil diupdate",data:r})}catch(e){return console.error("Status update error:",e),o.NextResponse.json({success:!1,message:"Terjadi kesalahan server"},{status:500})}}async function d(e){let{to:a,subject:t,pengaduan:s}=e;return s.nama_pelapor,s.bidang,s.kode,s.judul,s.bidang,process.env.NEXT_PUBLIC_APP_URL,s.kode,console.log("=== EMAIL NOTIFICATION ==="),console.log("To:",a),console.log("Subject:",t),console.log("Pengaduan:",s.kode),console.log("========================="),!0}let l=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/pengaduan/[id]/status/route",pathname:"/api/pengaduan/[id]/status",filename:"route",bundlePath:"app/api/pengaduan/[id]/status/route"},resolvedPagePath:"E:\\Dian\\Sistem Informasi Disnaker\\CascadeProjects\\windsurf-project\\sipelan\\app\\api\\pengaduan\\[id]\\status\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:g,serverHooks:m}=l,I="/api/pengaduan/[id]/status/route";function k(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},5662:(e,a,t)=>{t.d(a,{p:()=>i});var s=t(3974);let n="https://pdsfruupgjezqzigncjv.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkc2ZydXVwZ2plenF6aWduY2p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MDU5NzMsImV4cCI6MjA3NzI4MTk3M30.2qjemwRY0Y_D5bw_-RrzxVji6m8Ylo3tJqlRjTC0k7c";if(!n||!r)throw Error("Missing Supabase environment variables");(0,s.eI)(n,r);let i=(0,s.eI)(n,process.env.SUPABASE_SERVICE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var a=require("../../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),s=a.X(0,[276,376],()=>t(5018));module.exports=s})();